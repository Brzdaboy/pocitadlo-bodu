<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Počítadlo bodů - Více her</title>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Počítadlo bodů">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4">
<div class="max-w-md mx-auto space-y-4">

  <h1 class="text-2xl font-bold text-center">Počítadlo bodů</h1>

  <!-- Hry -->
  <div class="bg-white rounded-2xl shadow p-2 overflow-x-auto flex gap-2">
    <div id="gameTabs" class="flex gap-2"></div>
    <button onclick="newGame()" class="px-3 py-1 rounded-xl font-semibold border">+ Přidat hru</button>
  </div>

  <!-- Přidat hráče -->
  <div class="bg-white rounded-2xl shadow p-4">
    <button onclick="addPlayer()" class="w-full bg-blue-600 text-white py-2 rounded-xl font-semibold">
      Přidat hráče
    </button>
  </div>

  <!-- Aktuální kolo -->
  <div class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-semibold mb-2">Aktuální kolo</h2>
    <div id="players" class="space-y-3"></div>
    <button onclick="confirmRound()" class="mt-3 w-full bg-purple-600 text-white py-2 rounded-xl font-semibold">
      Potvrdit kolo
    </button>
  </div>

  <!-- Pořadí -->
  <div class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-semibold mb-2">Aktuální pořadí</h2>
    <ol id="leaderboard" class="text-sm"></ol>
  </div>

  <!-- Historie -->
  <div class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-semibold mb-2">Historie kol</h2>
    <div id="history" class="text-sm space-y-1"></div>
    <button onclick="resetGame()" class="mt-3 text-red-600 font-semibold">
      Reset hry
    </button>
  </div>

  <!-- Graf -->
  <div class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-semibold mb-2">Vývoj bodů</h2>
    <canvas id="scoreChart" height="200"></canvas>
  </div>

</div>

<script>
let currentGame = null;
let games = JSON.parse(localStorage.getItem('games') || '{}');
let scoreChart = null;

function saveGames(){ localStorage.setItem('games', JSON.stringify(games)); }
function saveCurrentGame(){ saveGames(); }

function newGame(){
  const name = prompt('Název nové hry:');
  if(!name) return;
  games[name] = { players: [], rounds: [] };
  saveGames();
  switchGame(name);
}

function populateGameTabs(){
  const el = document.getElementById('gameTabs');
  el.innerHTML = '';
  Object.keys(games).forEach(name=>{
    const b = document.createElement('button');
    b.textContent = name;
    b.className = `px-3 py-1 rounded-xl ${currentGame===name?'bg-purple-200':'bg-gray-200'}`;
    b.onclick = ()=>switchGame(name);
    el.appendChild(b);
  });
}

function switchGame(name){
  currentGame = name;
  populateGameTabs();
  renderPlayers();
  renderHistory();
  renderLeaderboard();
  renderChart();
}

function getPlayers(){ return games[currentGame].players; }
function getRounds(){ return games[currentGame].rounds; }

function addPlayer(){
  getPlayers().push({ name:`Hráč ${getPlayers().length+1}` });
  saveCurrentGame();
  renderPlayers();
  renderLeaderboard();
  renderChart();
}

function renderPlayers(){
  const el = document.getElementById('players');
  el.innerHTML='';
  getPlayers().forEach((p,i)=>{
    el.innerHTML += `
      <div class="flex gap-2">
        <input class="flex-1 border-b" value="${p.name}"
          onchange="renamePlayer(${i},this.value)">
        <input type="number" class="score w-20 border rounded-xl p-2">
        <button onclick="removePlayer(${i})"
          class="bg-red-500 text-white px-2 rounded-xl">X</button>
      </div>`;
  });
}

function renamePlayer(i,name){
  getPlayers()[i].name=name;
  saveCurrentGame();
  renderLeaderboard();
  renderChart();
}

function removePlayer(i){
  if(!confirm('Smazat hráče?')) return;
  getPlayers().splice(i,1);
  saveCurrentGame();
  renderPlayers();
  renderLeaderboard();
  renderChart();
}

function confirmRound(){
  const inputs = document.querySelectorAll('.score');
  if([...inputs].every(i=>i.value==='')){
    alert('Zadej alespoň jeden bod');
    return;
  }

  const round=[];
  inputs.forEach((i,idx)=>{
    round.push({ name:getPlayers()[idx].name, points:parseInt(i.value||0) });
    i.value='';
  });

  getRounds().push(round);
  saveCurrentGame();
  renderHistory();
  renderLeaderboard();
  renderChart();
}

function renderHistory(){
  const h=document.getElementById('history');
  h.innerHTML='';
  getRounds().forEach((r,ri)=>{
    const d=document.createElement('details');
    d.innerHTML=`<summary>Kolo ${ri+1}</summary>`;
    r.forEach((p,pi)=>{
      d.innerHTML+=`
        <div class="flex gap-2">
          <span class="flex-1">${p.name}</span>
          <input type="number" value="${p.points}"
            onchange="updateHistory(${ri},${pi},this.value)"
            class="border w-20 rounded">
        </div>`;
    });
    h.appendChild(d);
  });
}

function updateHistory(r,p,v){
  getRounds()[r][p].points=parseInt(v)||0;
  saveCurrentGame();
  renderLeaderboard();
  renderChart();
}

function renderLeaderboard(){
  const totals={};
  getPlayers().forEach(p=>totals[p.name]=0);
  getRounds().flat().forEach(r=>totals[r.name]+=r.points);

  const l=document.getElementById('leaderboard');
  l.innerHTML='';
  Object.entries(totals).sort((a,b)=>b[1]-a[1])
    .forEach(([n,p],i)=>{
      l.innerHTML+=`<li>${i+1}. ${n} – ${p} b</li>`;
    });
}

function resetGame(){
  if(!confirm('Resetovat skóre?')) return;
  games[currentGame].rounds=[];
  saveCurrentGame();
  renderHistory();
  renderLeaderboard();
  renderChart();
}

function renderChart(){
  const ctx=document.getElementById('scoreChart');
  if(scoreChart) scoreChart.destroy();

  const labels=getRounds().map((_,i)=>`Kolo ${i+1}`);

  const datasets=getPlayers().map(p=>{
    let sum=0;
    return {
      label:p.name,
      data:getRounds().map(r=>{
        const f=r.find(x=>x.name===p.name);
        sum+=f?f.points:0;
        return sum;
      }),
      tension:0.3,
      borderWidth:2,
      fill:false
    };
  });

  scoreChart=new Chart(ctx,{
    type:'line',
    data:{ labels, datasets },
    options:{
      plugins:{ legend:{ position:'bottom' }},
      scales:{ y:{ beginAtZero:true }}
    }
  });
}

if(Object.keys(games).length){
  switchGame(Object.keys(games)[0]);
}else populateGameTabs();
</script>
</body>
</html>
